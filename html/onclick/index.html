<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>onclick</title>
  </head>
  <body>
    <p onclick="alert(1337)" id="p">test</p>
    <script>
      const observer = new MutationObserver(records => {
        console.log(records);
      });
      observer.observe(p, { attributeFilter: ["onclick"] });

      const fnMap = new Map();

      const aELDesc = Object.getOwnPropertyDescriptor(EventTarget.prototype, "addEventListener");
      const aELFnOrig = aELDesc.value;
      const aELFn = function addEventListener(eventName, callback, ...args) {
        console.log("add event", this, eventName, callback, args);
        return Reflect.apply(aELFnOrig, this, [eventName, callback, ...args]);
      };
      Object.defineProperty(EventTarget.prototype, "addEventListener", {
        ...aELDesc,
        value: aELFn,
      });
      fnMap.set(aELFn, aELFnOrig);

      const oCDesc = Object.getOwnPropertyDescriptor(HTMLElement.prototype, "onclick");
      const oCFnOrig = oCDesc.set;
      const oCFn = function onclick(value) {
        console.log("set onclick", value, typeof value === "function");
        return Reflect.apply(oCFnOrig, this, [value]);
      };
      Object.defineProperty(HTMLElement.prototype, "onclick", {
        ...oCDesc,
        set: oCFn,
      });
      fnMap.set(oCFn, oCFnOrig);

      const tSDesc = Object.getOwnPropertyDescriptor(Function.prototype, "toString");
      const tSFnOrig = tSDesc.value;
      const tSFn = function toString(...args) {
        const fn = fnMap.get(this) || this;
        return Reflect.apply(tSFnOrig, fn, args);
      };
      Object.defineProperty(Function.prototype, "toString", {
        ...tSDesc,
        value: tSFn,
      });
      fnMap.set(tSFn, tSFnOrig);

      const tUDesc = Object.getOwnPropertyDescriptor(Function.prototype, "toSource");
      if (tUDesc != null) {
        const tUFnOrig = tUDesc.value;
        const tUFn = function toSource(...args) {
          const fn = fnMap.get(this) || this;
          return Reflect.apply(tUFnOrig, fn, args);
        };
        Object.defineProperty(Function.prototype, "toSource", {
          ...tUDesc,
          value: tUFn,
        });
        fnMap.set(tUFn, tUFnOrig);
      }

      p.onclick = () => console.log("assignment");
      p.addEventListener("click", () => console.log("addEventListener"));
    </script>
  </body>
</html>
