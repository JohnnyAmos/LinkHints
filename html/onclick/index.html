<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>onclick</title>
  </head>
  <body>
    <p onclick="alert(1337)" id="p">test</p>
    <script>
      const observer = new MutationObserver(records => {
        console.log(records);
      });
      observer.observe(p, { attributeFilter: ["onclick"] });

      const fnMap = new Map();

      function hookInto(obj, name, hook = undefined) {
        const desc = Object.getOwnPropertyDescriptor(obj, name);

        if (desc == null) {
          return
        }

        const prop = "value" in desc ? "value" : "set";
        const orig = desc[prop];

        const fn = {
          [name]:
            hook == null
              ? function(...args) {
                  return Reflect.apply(orig, fnMap.get(this) || this, args);
                }
              : function(...args) {
                  hook(this, ...args);
                  return Reflect.apply(orig, this, args);
                }
        }[name];

        Object.defineProperty(fn, "length", {
          ...Object.getOwnPropertyDescriptor(Function.prototype, "length"),
          value: orig.length,
        });

        Object.defineProperty(obj, name, {
          ...desc,
          [prop]: fn,
        });

        fnMap.set(fn, orig);
      }

      hookInto(EventTarget.prototype, "addEventListener", (that, eventName, callback, options) => {
        console.log("add event", that, eventName, callback, options);
      });

      hookInto(EventTarget.prototype, "removeEventListener", (that, eventName, callback, options) => {
        console.log("remove event", that, eventName, callback, options);
      });

      hookInto(HTMLElement.prototype, "onclick", (that, value) => {
        console.log("set onclick", that, value, typeof value === "function");
      });

      hookInto(Function.prototype, "toString");
      hookInto(Function.prototype, "toSource");

      p.onclick = () => console.log("assignment");
      p.addEventListener("click", () => console.log("addEventListener"));
    </script>
  </body>
</html>
